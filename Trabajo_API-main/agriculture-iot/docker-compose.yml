services:
  # === MQTT Broker ===
  mosquitto:
    build: ./mosquitto
    container_name: mqtt-broker
    hostname: mosquitto
    networks:
      sensor-net:
        ipv4_address: 10.10.1.10
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    restart: unless-stopped

  # === Asset Inventory API ===
  asset-api:
    build: ../
    container_name: asset-api
    user: "root"
    hostname: asset-api
    networks:
      mgmt-net:
        ipv4_address: 172.30.0.20
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=sqlite:///./database/data.db
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_ORIGINS=http://localhost:3000
    volumes:
      - api-data:/app/database
      - api-logs:/app/logs
    command: uvicorn app.main:app --host 0.0.0.0 --port 8002
    restart: unless-stopped

  # === MQTT Gateway ===
  mqtt-gateway:
    build: ./gateway
    container_name: mqtt-gateway
    hostname: mqtt-gateway
    networks:
      sensor-net:
        ipv4_address: 10.10.1.30
      mgmt-net:
        ipv4_address: 172.30.0.30
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - API_URL=http://asset-api:8002
      - API_USERNAME=superjefe
      - API_PASSWORD=P@ssw0rd!
    depends_on:
      - mosquitto
      - asset-api
    restart: unless-stopped

  # === IoT Sensors ===
  temp-sensor-001:
    build: ./sensors
    container_name: temp-sensor-001
    hostname: temp-dht22-001
    networks:
      sensor-net:
        ipv4_address: 10.10.1.101
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - SENSOR_ID=temp_dht22_001
      - ASSET_ID=10
      - LOCATION=Invernadero Tomates
      - PUBLISH_INTERVAL=10
    command: python temperature_sensor.py
    depends_on:
      - mosquitto
    restart: unless-stopped

  temp-sensor-002:
    build: ./sensors
    container_name: temp-sensor-002
    hostname: temp-dht22-002
    networks:
      sensor-net:
        ipv4_address: 10.10.1.102
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - SENSOR_ID=temp_dht22_002
      - ASSET_ID=11
      - LOCATION=Bodega de Vinos
      - PUBLISH_INTERVAL=15
    command: python temperature_sensor.py
    depends_on:
      - mosquitto
    restart: unless-stopped

  soil-sensor-001:
    build: ./sensors
    container_name: soil-sensor-001
    hostname: soil-cap-001
    networks:
      sensor-net:
        ipv4_address: 10.10.1.103
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - SENSOR_ID=soil_cap_001
      - ASSET_ID=12
      - LOCATION=Campo de Ma√≠z
      - PUBLISH_INTERVAL=30
    command: python soil_moisture_sensor.py
    depends_on:
      - mosquitto
    restart: unless-stopped

  soil-sensor-002:
    build: ./sensors
    container_name: soil-sensor-002
    hostname: soil-cap-002
    networks:
      sensor-net:
        ipv4_address: 10.10.1.104
    environment:
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      - SENSOR_ID=soil_cap_002
      - ASSET_ID=13
      - LOCATION=Huerto Urbano
      - PUBLISH_INTERVAL=30
    command: python soil_moisture_sensor.py
    depends_on:
      - mosquitto
    restart: unless-stopped

  # === Frontend Dashboard ===
  # === Frontend Dashboard ===
  frontend:
    build: ../frontend
    container_name: agriculture-dashboard
    hostname: frontend
    networks:
      mgmt-net:
        ipv4_address: 172.30.0.40
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ../frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../frontend/certs:/etc/nginx/certs:ro
      - ../frontend:/usr/share/nginx/html:ro
    environment:
      - REACT_APP_API_URL=https://localhost/api
      - REACT_APP_MQTT_WS_URL=ws://localhost:9001
    depends_on:
      - asset-api
    restart: unless-stopped

networks:
  sensor-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.1.0/24
  mgmt-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

volumes:
  mosquitto-data:
  mosquitto-log:
  api-data:
  api-logs: