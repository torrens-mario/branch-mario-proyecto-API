# Configuración de NGINX - Paso 5: HTTPS con TLS 1.3
# TLS 1.3 - El estándar más moderno, rápido y seguro

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Configuración de logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # ═══════════════════════════════════════════════════════════════
    # HEADERS DE SEGURIDAD - PASO 7: SEGURIDAD COMPLETA (OWASP Top 10 2021)
    # ═══════════════════════════════════════════════════════════════
    
    # A05:2021 - Security Misconfiguration
    # Previene clickjacking (UI Redressing)
    add_header X-Frame-Options "DENY" always;
    
    # Previene MIME sniffing attacks
    add_header X-Content-Type-Options "nosniff" always;
    
    # XSS Protection (legacy, pero aún recomendado)
    add_header X-XSS-Protection "1; mode=block" always;
    
    # No envía información sensible en el Referer
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions Policy (antes Feature-Policy)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
    
    # A03:2021 - Injection (XSS)
    # Content Security Policy - CONFIGURACIÓN ESTRICTA
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;" always;
    
    # ═══════════════════════════════════════════════════════════════
    # RATE LIMITING - PASO 7: PROTECCIÓN CONTRA ABUSO (A04:2021)
    # ═══════════════════════════════════════════════════════════════
    
    # Zona para limitar intentos de login (5 peticiones/minuto por IP)
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
    
    # Zona para limitar registro de usuarios (3 peticiones/minuto por IP)
    limit_req_zone $binary_remote_addr zone=register_limit:10m rate=3r/m;
    
    # Zona para limitar API general (60 peticiones/minuto por IP)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=60r/m;
    
    # Configuración de respuesta cuando se excede el límite
    limit_req_status 429;  # HTTP 429 Too Many Requests
    
    # Servidor HTTPS (puerto 443 interno → 8443 externo)
    server {
        listen 443 ssl;
        http2 on;
        server_name localhost;
        
        # ═══════════════════════════════════════════════════════════════
        # CONFIGURACIÓN SSL/TLS 1.3
        # ═══════════════════════════════════════════════════════════════
        
        # Certificados SSL (autofirmados para laboratorio)
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        
        # Protocolo TLS 1.3 SOLAMENTE (sin TLS 1.2, sin SSL obsoleto)
        ssl_protocols TLSv1.3;
        
        # TLS 1.3 Cipher suites (SOLO los 5 más seguros)
        # Nota: En TLS 1.3, los cipher suites están simplificados
        # No se especifican como en TLS 1.2, TLS 1.3 usa automáticamente:
        # - TLS_AES_256_GCM_SHA384
        # - TLS_CHACHA20_POLY1305_SHA256
        # - TLS_AES_128_GCM_SHA256
        # - TLS_AES_128_CCM_SHA256
        # - TLS_AES_128_CCM_8_SHA256
        
        # Perfect Forward Secrecy (obligatorio en TLS 1.3)
        ssl_prefer_server_ciphers off;  # TLS 1.3 no usa esta directiva
        
        # Sesión SSL
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # 0-RTT (opcional, desactivado por seguridad en laboratorio)
        ssl_early_data off;
        
        # OCSP Stapling (opcional, desactivado para certificados autofirmados)
        ssl_stapling off;
        ssl_stapling_verify off;
        
        # Headers de seguridad HTTPS
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        
        # ═══════════════════════════════════════════════════════════════
        # FIN CONFIGURACIÓN SSL/TLS 1.3
        # ═══════════════════════════════════════════════════════════════
        
        # Directorio raíz para archivos estáticos
        root /usr/share/nginx/html;
        index index.html;
        
        # Servir archivos estáticos del frontend
        location / {
            try_files $uri $uri/ /index.html;
            
            # PASO 7: Headers de seguridad también para archivos estáticos
            # NOTA: NGINX no hereda add_header del bloque http a location con archivos estáticos
            add_header X-Frame-Options "DENY" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
            add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;" always;
            add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }
        
        # Proxy para el backend (FastAPI) - PASANDO POR EL MITM
        # IMPORTANTE: NGINX termina TLS aquí, el tráfico NGINX→MITM→Backend es HTTP
        
        # A04:2021 - Rate limiting para login (máximo 5 intentos/minuto)
        location /api/login {
            limit_req zone=login_limit burst=2 nodelay;
            limit_req_status 429;
            
            proxy_pass http://mitm:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            add_header X-Content-Type-Options "nosniff" always;
        }
        
        # A04:2021 - Rate limiting para registro (máximo 3 intentos/minuto)
        location /api/register {
            limit_req zone=register_limit burst=1 nodelay;
            limit_req_status 429;
            
            proxy_pass http://mitm:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            add_header X-Content-Type-Options "nosniff" always;
        }
        
        # A04:2021 - Rate limiting general para API (60 peticiones/minuto)
        location /api/ {
            limit_req zone=api_limit burst=10 nodelay;
            limit_req_status 429;
            
            proxy_pass http://mitm:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Headers de seguridad adicionales
            add_header X-Content-Type-Options "nosniff" always;
        }
        
        # Desactivar logs para favicon (reducir ruido)
        location = /favicon.ico {
            log_not_found off;
            access_log off;
        }
        
        # Ocultar versión de NGINX
        server_tokens off;
    }
    
    # Redirigir HTTP a HTTPS (opcional, para mayor seguridad)
    server {
        listen 80;
        server_name localhost;
        
        # Redirigir todo el tráfico HTTP a HTTPS
        return 301 https://$server_name$request_uri;
    }
}
